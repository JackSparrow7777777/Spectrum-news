<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Spectrum News — Clean</title>

  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root {
      --primary-color: #3478F6;
      --secondary-color: #FF5733;
      --left-color: #E74C3C;
      --center-left-color: #F39C12;
      --center-color: #7F8C8D;
      --center-right-color: #3498DB;
      --right-color: #2E4172;
      --neutral-color: #27AE60;
      --light-gray: #f5f5f5;
      --medium-gray: #e0e0e0;
      --dark-gray: #333333;
      --text-color: #333333;
      --border-radius: 8px;
      --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: #f9f9f9;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 0 15px; }
    a { text-decoration: none; color: inherit; }
    ul { list-style: none; }
    button { cursor: pointer; border: none; background: none; font-family: inherit; }

    /* Header */
    header {
      background-color: #fff;
      box-shadow: var(--box-shadow);
      padding: 14px 0;
      position: sticky; top: 0; z-index: 100;
    }
    header .container { display: flex; gap: 16px; justify-content: space-between; align-items: center; }

    .logo h1 {
      font-size: 22px; font-weight: 700; color: var(--primary-color);
      letter-spacing: 0.2px;
    }
    .logo span { color: var(--dark-gray); font-weight: 500; }

    .search-bar { flex: 1; }
    .search-form { display: flex; gap: 10px; }
    .search-bar input {
      width: 100%; padding: 10px 14px; border: 1px solid var(--medium-gray);
      border-radius: 20px; font-size: 14px; background: #fff;
    }
    .search-btn {
      background: var(--primary-color); color: #fff; padding: 10px 16px;
      border-radius: 20px; font-weight: 500;
    }

    /* Main */
    main { padding: 18px 0; }
    main .container { display: flex; gap: 20px; }

    /* Sidebar */
    .sidebar {
      width: 260px; background: #fff; border-radius: var(--border-radius);
      box-shadow: var(--box-shadow); padding: 18px; position: sticky; top: 78px; height: fit-content;
    }

    .filter-section { margin-bottom: 22px; }
    .filter-section h2 { font-size: 18px; margin-bottom: 12px; color: var(--dark-gray); }
    .filter-section h3 { font-size: 14px; margin: 12px 0 8px; color: var(--dark-gray); }

    .select {
      width: 100%; padding: 10px 12px; border: 1px solid var(--medium-gray);
      border-radius: var(--border-radius); background: #fff; font-size: 14px;
    }

    /* Bias chips (UI only) */
    .bias-filter { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
    .bias-option { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .bias-circle { width: 22px; height: 22px; border-radius: 50%; margin-bottom: 6px; transition: transform 0.2s; }
    .bias-option:hover .bias-circle { transform: scale(1.15); }
    .bias-option.active .bias-circle { outline: 2px solid #000; outline-offset: 2px; }
    .left-bias{background: var(--left-color);} .center-left-bias{background: var(--center-left-color);}
    .center-bias{background: var(--center-color);} .center-right-bias{background: var(--center-right-color);}
    .right-bias{background: var(--right-color);}

    /* Reliability slider (UI only) */
    .slider { width: 100%; height: 5px; background: linear-gradient(to right, #ff4d4d, #ffcc00, #66cc66); outline: none; -webkit-appearance: none; border-radius: 5px; }
    .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #fff; border: 2px solid var(--primary-color); border-radius: 50%; cursor: pointer; }
    .slider-labels { display: flex; justify-content: space-between; margin-top: 6px; font-size: 12px; color: #666; }

    /* Topics */
    .topics-list li {
      padding: 8px 0; cursor: pointer; color: #555; transition: color 0.15s;
      display: flex; align-items: center; justify-content: space-between;
    }
    .topics-list li:hover { color: var(--primary-color); }
    .topics-list li.active { color: var(--primary-color); font-weight: 500; }

    /* Content area */
    .content { flex: 1; min-width: 0; }

    /* Status bar */
    .status-bar {
      display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between;
      background: #fff; border-radius: var(--border-radius); box-shadow: var(--box-shadow);
      padding: 10px 14px; margin-bottom: 14px; font-size: 13px; color: #666;
    }
    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--light-gray); border-radius: 999px; padding: 6px 10px; font-weight: 500;
    }
    .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--primary-color);
      animation: pulse 1.8s ease-in-out infinite;
    }
    @keyframes pulse { 0% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.25); opacity: 1; } 100% { transform: scale(1); opacity: 0.8; } }

    /* View options */
    .view-options {
      display: flex; background: #fff; border-radius: var(--border-radius); box-shadow: var(--box-shadow);
      overflow: hidden; margin-bottom: 16px;
    }
    .view-option { padding: 10px 16px; font-weight: 500; transition: background-color 0.15s; flex: 0 0 auto; }
    .view-option:hover { background: var(--light-gray); }
    .view-option.active { background: var(--primary-color); color: #fff; }

    /* News grid */
    #news-container { display: grid; grid-template-columns: 1fr; gap: 16px; }
    .cards-2 #news-container { grid-template-columns: repeat(2, 1fr); }
    .cards-3 #news-container { grid-template-columns: repeat(3, 1fr); }

    .article-card {
      background: #fff; border-radius: var(--border-radius); box-shadow: var(--box-shadow);
      overflow: hidden; transition: transform 0.18s ease, box-shadow 0.18s ease;
    }
    .article-card:hover { transform: translateY(-4px); box-shadow: 0 8px 22px rgba(0,0,0,0.08); }

    .article-source {
      display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-bottom: 1px solid var(--medium-gray);
    }
    .source-logo {
      width: 36px; height: 36px; background: var(--light-gray); border-radius: 6px; display: grid; place-items: center; font-weight: 700; color: #666;
    }
    .source-info { flex: 1; min-width: 0; }
    .source-name { font-weight: 600; font-size: 14px; }
    .source-meta { display: flex; gap: 8px; flex-wrap: wrap; color: #777; font-size: 12px; margin-top: 2px; }
    .reliability-badge { background: #e6f7e6; color: #27ae60; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }
    .bias-badge { background: #f2f3f4; color: #444; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }

    .thumb { width: 100%; height: 180px; object-fit: cover; background: #f2f2f2; }

    .article-content { padding: 14px; }
    .article-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #222; line-height: 1.35; }
    .article-meta { display: flex; justify-content: space-between; gap: 6px; color: #666; font-size: 13px; margin-bottom: 10px; }
    .article-description { color: #444; font-size: 14px; margin-bottom: 12px; }

    .article-actions { display: flex; justify-content: space-between; align-items: center; }
    .link-btn { color: var(--primary-color); font-weight: 600; padding: 8px 10px; border-radius: 6px; background: #f0f6ff; }

    /* Loading & error */
    .loading { text-align: center; padding: 28px; color: #666; }
    .error {
      background: #fee; color: #b40000; padding: 12px 14px; border-radius: var(--border-radius);
      border-left: 4px solid #b40000; margin-bottom: 16px;
    }

    /* Footer */
    footer { background: var(--dark-gray); color: #fff; padding: 20px 0; margin-top: 28px; }
    footer .container { display: flex; justify-content: space-between; align-items: center; font-size: 13px; opacity: 0.9; }

    /* Responsive */
    @media (max-width: 1024px) { .cards-3 #news-container { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 900px) {
      main .container { flex-direction: column; }
      .sidebar { width: 100%; position: static; order: 2; }
      .content { order: 1; }
    }
    @media (max-width: 600px) {
      header .container { flex-direction: column; align-items: stretch; }
      .search-form { width: 100%; }
      .cards-2 #news-container, .cards-3 #news-container { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body class="cards-3">
  <!-- ===== Header ===== -->
  <header>
    <div class="container">
      <div class="logo">
        <h1>Spectrum <span>News</span></h1>
      </div>

      <div class="search-bar">
        <form id="search-form" class="search-form" autocomplete="off">
          <input id="search-input" type="text" placeholder="Search news…" value="latest news" />
          <button class="search-btn" type="submit">Search</button>
        </form>
      </div>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main>
    <div class="container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <section class="filter-section">
          <h2>Filters</h2>

          <h3>Articles</h3>
          <select id="max-select" class="select">
            <option value="10">10 articles</option>
            <option value="20">20 articles</option>
            <option value="25">25 articles</option>
          </select>
        </section>

        <section class="filter-section">
          <h2>Bias (UI)</h2>
          <div class="bias-filter" id="bias-filter">
            <div class="bias-option" data-bias="left">
              <div class="bias-circle left-bias"></div><small>Left</small>
            </div>
            <div class="bias-option" data-bias="center-left">
              <div class="bias-circle center-left-bias"></div><small>CL</small>
            </div>
            <div class="bias-option active" data-bias="neutral">
              <div class="bias-circle center-bias"></div><small>Center</small>
            </div>
            <div class="bias-option" data-bias="center-right">
              <div class="bias-circle center-right-bias"></div><small>CR</small>
            </div>
            <div class="bias-option" data-bias="right">
              <div class="bias-circle right-bias"></div><small>Right</small>
            </div>
          </div>
          <p style="margin-top:8px;color:#777;font-size:12px;">(Visual only for now; API call unchanged)</p>
        </section>

        <section class="filter-section">
          <h2>Reliability (UI)</h2>
          <input id="reliability" class="slider" type="range" min="0" max="100" value="0" />
          <div class="slider-labels">
            <span>Low</span><span>Medium</span><span>High</span>
          </div>
        </section>

        <section class="filter-section">
          <h2>Time Range</h2>
          <select id="time-range" class="select">
            <option value="any">Any time</option>
            <option value="24h">Past 24 hours</option>
            <option value="7d">Past 7 days</option>
            <option value="30d">Past 30 days</option>
          </select>
        </section>

        <section class="filter-section">
          <h2>Topics</h2>
          <!-- IMPORTANT: Use valid GNews topics in data-topic -->
          <ul class="topics-list" id="topics">
            <li class="active" data-topic="">All</li>
            <li data-topic="breaking-news">Breaking</li>
            <li data-topic="world">World</li>
            <li data-topic="business">Business</li>
            <li data-topic="technology">Technology</li>
            <li data-topic="entertainment">Entertainment</li>
            <li data-topic="sports">Sports</li>
            <li data-topic="science">Science</li>
            <li data-topic="health">Health</li>
          </ul>
        </section>
      </aside>

      <!-- Content -->
      <section class="content">
        <div class="status-bar" id="status-bar">
          <div class="pill"><span class="dot" aria-hidden="true"></span><span id="live-label">Live</span></div>
          <div id="status-text">Loading…</div>
          <div id="cache-text" style="opacity:0.8;"></div>
        </div>

        <div class="view-options" role="tablist" aria-label="View options">
          <button class="view-option" data-view="1">List</button>
          <button class="view-option active" data-view="2">2-up</button>
          <button class="view-option" data-view="3">3-up</button>
        </div>

        <div id="error" class="error" style="display:none;"></div>
        <div id="loading" class="loading" style="display:none;">Loading latest news…</div>

        <div id="news-container" aria-live="polite"></div>
      </section>
    </div>
  </main>

  <footer>
    <div class="container">
      <div>© <span id="year"></span> Spectrum News</div>
      <div>Powered by your Netlify Function + GNews</div>
    </div>
  </footer>

  <script>
    class NewsApp {
      constructor() {
        this.apiEndpoint = '/.netlify/functions/news';
        this.currentTopic = ''; // <-- use topic, not category
        this.autoRefreshMs = 30 * 60 * 1000; // 30 minutes
        this.viewRoot = document.body;
        this.bindUI();
        this.startAutoRefresh();
        this.loadNews();
      }

      bindUI() {
        document.getElementById('year').textContent = new Date().getFullYear();

        // Search
        document.getElementById('search-form').addEventListener('submit', (e) => {
          e.preventDefault(); this.loadNews();
        });

        // Articles count
        document.getElementById('max-select').addEventListener('change', () => this.loadNews());

        // Time range (client-side filter)
        document.getElementById('time-range').addEventListener('change', () => this.loadNews());

        // Topics (now data-topic)
        document.querySelectorAll('#topics li').forEach(li => {
          li.addEventListener('click', () => {
            document.querySelectorAll('#topics li').forEach(x => x.classList.remove('active'));
            li.classList.add('active');
            this.currentTopic = li.dataset.topic || '';
            this.loadNews();
          });
        });

        // Bias UI only
        document.querySelectorAll('#bias-filter .bias-option').forEach(opt => {
          opt.addEventListener('click', () => {
            document.querySelectorAll('#bias-filter .bias-option').forEach(x => x.classList.remove('active'));
            opt.classList.add('active');
          });
        });

        // View options
        document.querySelectorAll('.view-option').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.view-option').forEach(x => x.classList.remove('active'));
            btn.classList.add('active');
            const mode = btn.dataset.view;
            this.viewRoot.classList.remove('cards-1', 'cards-2', 'cards-3');
            this.viewRoot.classList.add(`cards-${mode}`);
          });
        });
      }

      startAutoRefresh() { setInterval(() => this.loadNews(), this.autoRefreshMs); }

      async loadNews() {
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const container = document.getElementById('news-container');
        const statusText = document.getElementById('status-text');
        const cacheText = document.getElementById('cache-text');

        loadingEl.style.display = 'block';
        errorEl.style.display = 'none';
        container.innerHTML = '';

        try {
          const q = (document.getElementById('search-input').value || 'latest news').trim();
          const max = document.getElementById('max-select').value;

          const params = new URLSearchParams({ q, max, expand: 'content' });
          if (this.currentTopic) params.set('topic', this.currentTopic); // <-- FIX

          const res = await fetch(`${this.apiEndpoint}?${params.toString()}`);
          if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);

          const data = await res.json();
          if (data.error) throw new Error(data.error);

          // client-side time filtering
          const timeRange = document.getElementById('time-range').value;
          const filtered = this.filterByTimeRange(data.articles || [], timeRange);

          this.renderArticles(filtered);

          const cached = res.headers.get('X-Cache') === 'HIT' ? 'cached' : 'fresh';
          statusText.textContent = `Loaded ${filtered.length} articles • Last updated: ${new Date().toLocaleTimeString()}`;
          cacheText.textContent = `Response: ${cached}`;
        } catch (err) {
          errorEl.textContent = `Failed to load news: ${err.message}`;
          errorEl.style.display = 'block';
        } finally {
          loadingEl.style.display = 'none';
        }
      }

      filterByTimeRange(articles, range) {
        if (range === 'any') return articles;
        const now = Date.now();
        let cutoff = 0;
        if (range === '24h') cutoff = now - 24 * 60 * 60 * 1000;
        if (range === '7d')  cutoff = now - 7  * 24 * 60 * 60 * 1000;
        if (range === '30d') cutoff = now - 30 * 24 * 60 * 60 * 1000;
        return articles.filter(a => {
          if (!a.publishedAt) return true;
          const t = new Date(a.publishedAt).getTime();
          return isNaN(t) ? true : t >= cutoff;
        });
      }

      renderArticles(articles) {
        const el = document.getElementById('news-container');
        if (!articles || !articles.length) {
          el.innerHTML = `<div class="loading" style="padding:36px;">No articles found. Try a different search.</div>`;
          return;
        }

        el.innerHTML = articles.map(a => this.cardHTML(a)).join('');
        el.querySelectorAll('.article-card').forEach(card => {
          card.addEventListener('click', () => {
            const url = card.getAttribute('data-url');
            if (url) window.open(url, '_blank', 'noopener,noreferrer');
          });
        });
        el.querySelectorAll('.link-btn').forEach(btn => {
          btn.addEventListener('click', (e) => e.stopPropagation());
        });
      }

      cardHTML(article) {
        const title = this.truncate(article?.title, 120) || 'Untitled';
        const desc = this.truncate(article?.description, 180) || 'No description available.';
        const srcName = article?.source?.name || 'Unknown';
        const dateText = this.humanTime(article?.publishedAt);
        const img = article?.image || '';
        const url = article?.url || '#';

        const reliabilityText = 'Unrated';
        const biasText = 'Neutral';

        return `
          <article class="article-card" data-url="${this.escape(url)}" tabindex="0" role="article" aria-label="${this.escape(title)}">
            <div class="article-source">
              <div class="source-logo" aria-hidden="true">${this.initial(srcName)}</div>
              <div class="source-info">
                <div class="source-name">${this.escape(srcName)}</div>
                <div class="source-meta">
                  <span class="reliability-badge">${this.escape(reliabilityText)}</span>
                  <span class="bias-badge">${this.escape(biasText)}</span>
                </div>
              </div>
            </div>

            ${img ? `<img class="thumb" src="${this.escape(img)}" alt="" onerror="this.style.display='none'">` : ''}

            <div class="article-content">
              <h3 class="article-title">${this.escape(title)}</h3>
              <div class="article-meta">
                <span>${this.escape(dateText)}</span>
                <span>${this.escape(new URL(url, location.href).hostname || '')}</span>
              </div>
              <p class="article-description">${this.escape(desc)}</p>
              <div class="article-actions">
                <a class="link-btn" href="${this.escape(url)}" target="_blank" rel="noopener noreferrer">Read full article →</a>
              </div>
            </div>
          </article>
        `;
      }

      truncate(t, n) { if (!t) return ''; return t.length > n ? t.slice(0, n - 1) + '…' : t; }

      humanTime(iso) {
        if (!iso) return 'Unknown';
        const d = new Date(iso);
        if (isNaN(d)) return 'Unknown';
        const diffMs = Date.now() - d.getTime();
        const h = Math.floor(diffMs / (1000 * 60 * 60));
        if (h < 1) return 'Just now';
        if (h < 24) return `${h}h ago`;
        const days = Math.floor(h / 24);
        if (days === 1) return 'Yesterday';
        return d.toLocaleDateString();
      }

      initial(name) { const c = (name || '').trim()[0]; return (c || '?').toUpperCase(); }

      escape(str) {
        return String(str || '').replace(/[&<>"']/g, s => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[s]));
      }
    }

    document.addEventListener('DOMContentLoaded', () => new NewsApp());
  </script>
</body>
</html>
