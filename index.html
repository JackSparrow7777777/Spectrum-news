<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Spectrum News — Clean</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --primary-color:#3478F6;
      --secondary-color:#FF5733;
      /* Left->Blue, CL->Sky, Center->Gray, CR->Orange, Right->Red */
      --left-color:#2E4172;
      --center-left-color:#87CEEB;
      --center-color:#7F8C8D;
      --center-right-color:#F39C12;
      --right-color:#E74C3C;

      --light-gray:#f5f5f5; --medium-gray:#e0e0e0; --dark-gray:#333;
      --text-color:#333; --border-radius:8px; --box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Roboto',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;line-height:1.6;color:var(--text-color);background:#f9f9f9}
    .container{max-width:1200px;margin:0 auto;padding:0 15px}
    a{text-decoration:none;color:inherit} ul{list-style:none} button{cursor:pointer;border:0;background:none;font:inherit}
    header{background:#fff;box-shadow:var(--box-shadow);padding:14px 0;position:sticky;top:0;z-index:100}
    header .container{display:flex;gap:16px;justify-content:space-between;align-items:center}
    .logo h1{font-size:22px;font-weight:700;color:var(--primary-color);letter-spacing:.2px}
    .logo span{color:var(--dark-gray);font-weight:500}
    .search-bar{flex:1}.search-form{display:flex;gap:10px}
    .search-bar input{width:100%;padding:10px 14px;border:1px solid var(--medium-gray);border-radius:20px;font-size:14px;background:#fff}
    .search-btn{background:var(--primary-color);color:#fff;padding:10px 16px;border-radius:20px;font-weight:500}
    .auth .sign-in{background:var(--primary-color);color:#fff;padding:8px 14px;border-radius:var(--border-radius);font-weight:500}
    main{padding:18px 0} main .container{display:flex;gap:20px}
    .sidebar{width:260px;background:#fff;border-radius:var(--border-radius);box-shadow:var(--box-shadow);padding:18px;position:sticky;top:78px;height:fit-content}
    .filter-section{margin-bottom:22px}
    .filter-section h2{font-size:18px;margin-bottom:12px;color:var(--dark-gray)}
    .filter-section h3{font-size:14px;margin:12px 0 8px;color:var(--dark-gray)}
    .select{width:100%;padding:10px 12px;border:1px solid var(--medium-gray);border-radius:var(--border-radius);background:#fff;font-size:14px}

    /* Bias chips */
    .bias-filter,.tier-filter{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .bias-option,.tier-option{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer}
    .bias-circle{width:22px;height:22px;border-radius:50%;margin-bottom:2px;transition:transform .2s}
    .bias-option:hover .bias-circle{transform:scale(1.15)}
    .bias-option.active .bias-circle,.tier-option.active{outline:2px solid #000;outline-offset:2px;border-radius:999px}
    .left-bias{background:var(--left-color)} .center-left-bias{background:var(--center-left-color)}
    .center-bias{background:var(--center-color)} .center-right-bias{background:var(--center-right-color)}
    .right-bias{background:var(--right-color)}

    /* Tier buttons */
    .tier-chip{padding:6px 10px;border-radius:999px;background:#f0f0f0;font-weight:500}
    .tier-option.active .tier-chip{background:#e8f1ff;border:1px solid #cfe0ff}

    /* Content */
    .content{flex:1;min-width:0}
    .status-bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;background:#fff;border-radius:var(--border-radius);box-shadow:var(--box-shadow);padding:10px 14px;margin-bottom:14px;font-size:13px;color:#666}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--light-gray);border-radius:999px;padding:6px 10px;font-weight:500}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--primary-color);animation:pulse 1.8s ease-in-out infinite}
    @keyframes pulse{0%{transform:scale(1);opacity:.8}50%{transform:scale(1.25);opacity:1}100%{transform:scale(1);opacity:.8}}

    .view-options{display:flex;background:#fff;border-radius:var(--border-radius);box-shadow:var(--box-shadow);overflow:hidden;margin-bottom:10px}
    .view-option{padding:10px 16px;font-weight:500;transition:background-color .15s;flex:0 0 auto}
    .view-option:hover{background:var(--light-gray)} .view-option.active{background:var(--primary-color);color:#fff}

    /* Compare toggle + bar */
    .toolbar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    .btn{padding:9px 12px;border-radius:8px;background:#fff;box-shadow:var(--box-shadow);font-weight:600}
    .btn-primary{background:var(--primary-color);color:#fff}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .compare-bar{position:sticky;bottom:10px;z-index:5;display:none}
    .compare-bar .inner{display:flex;gap:10px;align-items:center;justify-content:space-between;background:#fff;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.08);padding:10px 12px}
    .count-pill{background:#f0f6ff;border-radius:999px;padding:6px 10px;font-weight:600}

    /* Grid */
    #news-container{display:grid;grid-template-columns:1fr;gap:16px}
    .cards-2 #news-container{grid-template-columns:repeat(2,1fr)}
    .cards-3 #news-container{grid-template-columns:repeat(3,1fr)}
    .article-card{background:#fff;border-radius:var(--border-radius);box-shadow:var(--box-shadow);overflow:hidden;transition:transform .18s ease,box-shadow .18s ease;position:relative}
    .article-card:hover{transform:translateY(-4px);box-shadow:0 8px 22px rgba(0,0,0,.08)}
    .select-box{position:absolute;top:10px;left:10px;width:20px;height:20px;display:none}
    .compare-mode .select-box{display:block}
    .article-source{display:flex;align-items:center;gap:12px;padding:12px 14px;border-bottom:1px solid var(--medium-gray)}
    .source-logo{width:36px;height:36px;background:var(--light-gray);border-radius:6px;display:grid;place-items:center;font-weight:700;color:#666}
    .source-info{flex:1;min-width:0}
    .source-name{font-weight:600;font-size:14px}
    .source-meta{display:flex;gap:8px;flex-wrap:wrap;color:#777;font-size:12px;margin-top:2px}
    .reliability-badge{background:#e6f7e6;color:#27ae60;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .bias-badge{background:#f2f3f4;color:#444;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}

    .thumb{width:100%;height:180px;object-fit:cover;background:#f2f2f2}
    .article-content{padding:14px}
    .article-title{font-size:18px;font-weight:600;margin-bottom:8px;color:#222;line-height:1.35}
    .article-meta{display:flex;justify-content:space-between;gap:6px;color:#666;font-size:13px;margin-bottom:10px}
    .article-description{color:#444;font-size:14px;margin-bottom:12px}
    .article-actions{display:flex;justify-content:space-between;align-items:center}
    .link-btn{color:var(--primary-color);font-weight:600;padding:8px 10px;border-radius:6px;background:#f0f6ff}

    /* Loading & error */
    .loading{text-align:center;padding:28px;color:#666}
    .error{background:#fee;color:#b40000;padding:12px 14px;border-radius:var(--border-radius);border-left:4px solid #b40000;margin-bottom:16px}

    /* Bias badge palette */
    .bias-badge.left{background:#e7f3fb;color:#2E4172}
    .bias-badge.lean-left{background:#eaf6ff;color:#2E86C1}
    .bias-badge.center{background:#f2f3f4;color:#7F8C8D}
    .bias-badge.lean-right{background:#fef5e7;color:#F39C12}
    .bias-badge.right{background:#fde9e7;color:#E74C3C}
    .bias-badge.unknown{background:#eee;color:#666}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000}
    .modal-content{background:#fff;margin:40px auto;padding:20px;width:min(1000px,92%);border-radius:12px;position:relative;box-shadow:0 20px 40px rgba(0,0,0,.2)}
    .close-modal{position:absolute;top:10px;right:14px;font-size:24px;cursor:pointer}
    .compare-header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .mini-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#f6f7f9;font-weight:600;font-size:12px}
    .agree{color:#1a7f37;background:#e6f4ea}.differ{color:#b80606;background:#fdeaea}
    .comparison-container{display:flex;gap:16px;margin:12px 0;flex-wrap:wrap}
    .article-column{flex:1;min-width:260px;border-radius:12px;padding:14px}
    .left-article{background:#f0f5ff}.right-article{background:#fff7f0}
    .section{margin:14px 0}
    .section h3{margin-bottom:8px}
    .section ul{padding-left:18px}
    .section li{margin:6px 0}

    footer{background:var(--dark-gray);color:#fff;padding:20px 0;margin-top:28px}
    footer .container{display:flex;justify-content:space-between;align-items:center;font-size:13px;opacity:.9}

    @media(max-width:1024px){.cards-3 #news-container{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:900px){main .container{flex-direction:column}.sidebar{width:100%;position:static;order:2}.content{order:1}}
    @media(max-width:600px){header .container{flex-direction:column;align-items:stretch}.search-form{width:100%}.cards-2 #news-container,.cards-3 #news-container{grid-template-columns:1fr}}
  </style>
</head>

<body class="cards-3">
<header>
  <div class="container">
    <div class="logo"><h1>Spectrum <span>News</span></h1></div>
    <div class="search-bar">
      <form id="search-form" class="search-form" autocomplete="off">
        <input id="search-input" type="text" placeholder="Search news…" value="latest news"/>
        <button class="search-btn" type="submit">Search</button>
      </form>
    </div>
    <div class="auth"><a class="sign-in" href="#" aria-disabled="true">Sign in</a></div>
  </div>
</header>

<main>
  <div class="container">
    <aside class="sidebar">
      <section class="filter-section">
        <h2>Filters</h2>
        <h3>Country</h3>
        <select id="country-select" class="select">
          <option value="us">United States</option><option value="gb">United Kingdom</option>
          <option value="ca">Canada</option><option value="au">Australia</option>
          <option value="de">Germany</option><option value="fr">France</option>
          <option value="in">India</option><option value="jp">Japan</option>
          <option value="kr">Korea</option>
        </select>
        <h3>Language</h3>
        <select id="language-select" class="select">
          <option value="en">English</option><option value="es">Spanish</option><option value="fr">French</option>
          <option value="de">German</option><option value="it">Italian</option><option value="pt">Portuguese</option>
          <option value="ko">Korean</option><option value="ja">Japanese</option>
        </select>
        <h3>Articles</h3>
        <select id="max-select" class="select">
          <option value="10">10 articles</option><option value="20">20 articles</option><option value="25">25 articles</option>
        </select>
      </section>

      <section class="filter-section">
        <h2>Bias</h2>
        <div class="bias-filter" id="bias-filter">
          <div class="bias-option active" data-bias="default"><div class="bias-circle" style="background:#e0e0e0"></div><small>Default</small></div>
          <div class="bias-option" data-bias="left"><div class="bias-circle left-bias"></div><small>Left</small></div>
          <div class="bias-option" data-bias="lean-left"><div class="bias-circle center-left-bias"></div><small>CL</small></div>
          <div class="bias-option" data-bias="center"><div class="bias-circle center-bias"></div><small>Center</small></div>
          <div class="bias-option" data-bias="lean-right"><div class="bias-circle center-right-bias"></div><small>CR</small></div>
          <div class="bias-option" data-bias="right"><div class="bias-circle right-bias"></div><small>Right</small></div>
        </div>
      </section>

      <section class="filter-section">
        <h2>Reliability</h2>
        <div class="tier-filter" id="tier-filter">
          <div class="tier-option active" data-tier="any"><span class="tier-chip">All</span></div>
          <div class="tier-option" data-tier="less-legacy"><span class="tier-chip">Less legacy</span></div>
          <div class="tier-option" data-tier="unidentified"><span class="tier-chip">Unidentified</span></div>
          <div class="tier-option" data-tier="legacy"><span class="tier-chip">Legacy</span></div>
        </div>
      </section>

      <section class="filter-section">
        <h2>Time Range</h2>
        <select id="time-range" class="select">
          <option value="any">Any time</option><option value="24h">Past 24 hours</option>
          <option value="7d">Past 7 days</option><option value="30d">Past 30 days</option>
        </select>
      </section>

      <section class="filter-section">
        <h2>Topics</h2>
        <ul class="topics-list" id="topics">
          <li class="active" data-category="">All</li>
          <li data-category="general">General</li><li data-category="world">World</li>
          <li data-category="business">Business</li><li data-category="technology">Technology</li>
          <li data-category="entertainment">Entertainment</li><li data-category="sports">Sports</li>
          <li data-category="science">Science</li><li data-category="health">Health</li>
        </ul>
      </section>
    </aside>

    <section class="content">
      <div class="status-bar">
        <div class="pill"><span class="dot" aria-hidden="true"></span><span id="live-label">Live</span></div>
        <div id="status-text">Loading…</div>
        <div id="cache-text" style="opacity:.8;"></div>
      </div>

      <div class="toolbar">
        <div class="view-options" role="tablist" aria-label="View options">
          <button class="view-option" data-view="1">List</button>
          <button class="view-option active" data-view="2">2-up</button>
          <button class="view-option" data-view="3">3-up</button>
        </div>
        <button id="compare-toggle" class="btn">Compare</button>
      </div>

      <div id="error" class="error" style="display:none;"></div>
      <div id="loading" class="loading" style="display:none;">Loading latest news…</div>

      <div id="news-container" aria-live="polite"></div>

      <!-- sticky compare bar -->
      <div class="compare-bar" id="compare-bar">
        <div class="inner">
          <div class="count-pill"><span id="compare-count">0</span>/2 selected</div>
          <div style="display:flex;gap:8px;">
            <button id="clear-compare" class="btn">Clear</button>
            <button id="run-compare" class="btn btn-primary" disabled>Analyze & Compare</button>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<footer>
  <div class="container">
    <div>© <span id="year"></span> Spectrum News</div>
    <div>Powered by your Netlify Function + GNews</div>
  </div>
</footer>

<!-- Compare modal -->
<div id="compare-modal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <span class="close-modal" id="close-modal">&times;</span>
    <div id="compare-body">Analyzing…</div>
  </div>
</div>

<script>
class NewsApp{
  constructor(){
    this.apiEndpoint='/.netlify/functions/news';
    this.compareEndpoint='/.netlify/functions/compare';
    this.currentCategory='';
    this.currentBias='default';
    this.currentTier='any';
    this.autoRefreshMs=30*60*1000;
    this.viewRoot=document.body;

    this.compareMode=false;
    this.currentArticles=[];
    this.selectedIndexes=new Set();

    this.bindUI();
    this.startAutoRefresh();
    this.loadNews();
  }

  bindUI(){
    document.getElementById('year').textContent=new Date().getFullYear();

    document.getElementById('search-form').addEventListener('submit',(e)=>{e.preventDefault();this.loadNews();});
    document.getElementById('country-select').addEventListener('change',()=>this.loadNews());
    document.getElementById('language-select').addEventListener('change',()=>this.loadNews());
    document.getElementById('max-select').addEventListener('change',()=>this.loadNews());
    document.getElementById('time-range').addEventListener('change',()=>this.loadNews());

    document.querySelectorAll('#topics li').forEach(li=>{
      li.addEventListener('click',()=>{
        document.querySelectorAll('#topics li').forEach(x=>x.classList.remove('active'));
        li.classList.add('active');
        this.currentCategory=li.dataset.category||'';
        this.loadNews();
      });
    });

    document.querySelectorAll('#bias-filter .bias-option').forEach(opt=>{
      opt.addEventListener('click',()=>{
        document.querySelectorAll('#bias-filter .bias-option').forEach(x=>x.classList.remove('active'));
        opt.classList.add('active');
        this.currentBias=opt.dataset.bias||'default';
        this.loadNews();
      });
    });

    document.querySelectorAll('#tier-filter .tier-option').forEach(opt=>{
      opt.addEventListener('click',()=>{
        document.querySelectorAll('#tier-filter .tier-option').forEach(x=>x.classList.remove('active'));
        opt.classList.add('active');
        this.currentTier=opt.dataset.tier||'any';
        this.loadNews();
      });
    });

    document.querySelectorAll('.view-option').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.view-option').forEach(x=>x.classList.remove('active'));
        btn.classList.add('active');
        const mode=btn.dataset.view;
        this.viewRoot.classList.remove('cards-1','cards-2','cards-3');
        this.viewRoot.classList.add(`cards-${mode}`);
      });
    });

    // Compare
    document.getElementById('compare-toggle').addEventListener('click',()=>{
      this.compareMode=!this.compareMode;
      document.getElementById('compare-toggle').classList.toggle('btn-primary',this.compareMode);
      document.getElementById('news-container').classList.toggle('compare-mode',this.compareMode);
      document.querySelectorAll('.select-box').forEach(cb=>cb.style.display=this.compareMode?'block':'none');
      this.selectedIndexes.clear(); this.updateCompareBar();
    });
    document.getElementById('clear-compare').addEventListener('click',()=>{
      this.selectedIndexes.clear(); this.updateCompareBar();
      document.querySelectorAll('.select-box').forEach(cb=>cb.checked=false);
    });
    document.getElementById('run-compare').addEventListener('click',()=>this.runCompare());

    // Modal
    document.getElementById('close-modal').addEventListener('click',()=>this.hideModal());
    document.getElementById('compare-modal').addEventListener('click',(e)=>{ if(e.target.id==='compare-modal') this.hideModal(); });
  }

  startAutoRefresh(){ setInterval(()=>this.loadNews(),this.autoRefreshMs); }

  async loadNews(){
    const loadingEl=document.getElementById('loading');
    const errorEl=document.getElementById('error');
    const container=document.getElementById('news-container');
    const statusText=document.getElementById('status-text');
    const cacheText=document.getElementById('cache-text');

    loadingEl.style.display='block'; errorEl.style.display='none'; container.innerHTML='';

    try{
      const q=(document.getElementById('search-input').value||'latest news').trim();
      const country=document.getElementById('country-select').value;
      const lang=document.getElementById('language-select').value;
      const max=document.getElementById('max-select').value;

      const params=new URLSearchParams({q,country,lang,max,expand:'content'});
      if(this.currentCategory) params.set('category',this.currentCategory);
      if(this.currentBias && this.currentBias!=='default') params.set('bias',this.currentBias);
      if(this.currentTier && this.currentTier!=='any') params.set('tier',this.currentTier);

      const res=await fetch(`${this.apiEndpoint}?${params.toString()}`);
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const data=await res.json(); if(data.error) throw new Error(data.error);

      const timeRange=document.getElementById('time-range').value;
      const filtered=this.filterByTimeRange(data.articles||[],timeRange);

      this.currentArticles=filtered;
      this.renderArticles(filtered);

      const cached=res.headers.get('X-Cache')==='HIT'?'cached':'fresh';
      statusText.textContent=`Loaded ${filtered.length} articles • Last updated: ${new Date().toLocaleTimeString()}`;
      cacheText.textContent=`Response: ${cached}`;
    }catch(err){
      errorEl.textContent=`Failed to load news: ${err.message}`;
      errorEl.style.display='block';
    }finally{ loadingEl.style.display='none'; }
  }

  filterByTimeRange(articles,range){
    if(range==='any') return articles;
    const now=Date.now();
    let cutoff=0;
    if(range==='24h') cutoff=now-24*60*60*1000;
    if(range==='7d') cutoff=now-7*24*60*60*1000;
    if(range==='30d') cutoff=now-30*24*60*60*1000;
    return articles.filter(a=>{
      if(!a.publishedAt) return true;
      const t=new Date(a.publishedAt).getTime(); return isNaN(t)?true:t>=cutoff;
    });
  }

  renderArticles(articles){
    const el=document.getElementById('news-container');
    if(!articles || !articles.length){ el.innerHTML=`<div class="loading" style="padding:36px;">No articles found. Try a different search.</div>`; return; }

    el.innerHTML=articles.map((a,idx)=>this.cardHTML(a,idx)).join('');

    // card clicks and checkboxes
    el.querySelectorAll('.article-card').forEach(card=>{
      const url=card.getAttribute('data-url');
      card.addEventListener('click',(e)=>{
        if(e.target.classList.contains('select-box')) return; // ignore when clicking checkbox
        if(url) window.open(url,'_blank','noopener,noreferrer');
      });
    });
    el.querySelectorAll('.select-box').forEach(cb=>{
      cb.addEventListener('change',()=>{
        const idx=Number(cb.dataset.index);
        if(cb.checked){
          if(this.selectedIndexes.size>=2){
            cb.checked=false; return;
          }
          this.selectedIndexes.add(idx);
        }else{
          this.selectedIndexes.delete(idx);
        }
        this.updateCompareBar();
      });
    });

    // reset compare visuals per render
    document.querySelectorAll('.select-box').forEach(cb=>cb.style.display=this.compareMode?'block':'none');
    this.updateCompareBar();
  }

  updateCompareBar(){
    const bar=document.getElementById('compare-bar');
    const count=this.selectedIndexes.size;
    document.getElementById('compare-count').textContent=count;
    document.getElementById('run-compare').disabled=(count!==2);
    bar.style.display= this.compareMode && (count>=0) ? 'block' : 'none';
  }

  async runCompare(){
    if(this.selectedIndexes.size!==2) return;
    const [i1,i2]=[...this.selectedIndexes];
    const a=this.currentArticles[i1], b=this.currentArticles[i2];

    this.showModal(`<div class="loading">Analyzing and comparing…</div>`);

    try{
      const res=await fetch(this.compareEndpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({a,b})});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data=await res.json();
      if(!data || !data.result) throw new Error('No result from analyzer');
      this.renderComparison(a,b,data.result);
    }catch(err){
      this.showModal(`<div class="error">Compare failed: ${this.escape(err.message)}</div>`);
    }
  }

  renderComparison(a,b,r){
    const verdict=(r.verdict||'mixed').toLowerCase();
    const badge=verdict==='agree' ? `<span class="mini-badge agree">AGREE</span>` :
                 verdict==='disagree' ? `<span class="mini-badge differ">DIFFER</span>` :
                 `<span class="mini-badge">MIXED</span>`;

    const html=`
      <div class="compare-header">
        <strong>Compare Sources</strong>
        ${badge}
      </div>

      <div class="comparison-container">
        <div class="article-column left-article">
          <strong>${this.escape(a.title||'Article A')}</strong>
          <div style="font-size:12px;color:#666;margin:4px 0">${this.escape(a.source?.name||'')}</div>
          <p style="margin-top:6px">${this.escape(this.truncate(a.description||a.content,180))}</p>
          <a href="${this.escape(a.url||'#')}" target="_blank" class="link-btn" style="display:inline-block;margin-top:6px">Read Original →</a>
        </div>
        <div class="article-column right-article">
          <strong>${this.escape(b.title||'Article B')}</strong>
          <div style="font-size:12px;color:#666;margin:4px 0">${this.escape(b.source?.name||'')}</div>
          <p style="margin-top:6px">${this.escape(this.truncate(b.description||b.content,180))}</p>
          <a href="${this.escape(b.url||'#')}" target="_blank" class="link-btn" style="display:inline-block;margin-top:6px">Read Original →</a>
        </div>
      </div>

      <div class="section">
        <h3>Common Facts</h3>
        <ul>${(r.common_facts||[]).map(x=>`<li>${this.escape(x)}</li>`).join('')||'<li>None detected</li>'}</ul>
      </div>

      <div class="section">
        <h3>Key Differences</h3>
        <ul>${(r.key_differences||[]).map(x=>`<li>${this.escape(x)}</li>`).join('')||'<li>None detected</li>'}</ul>
      </div>
    `;
    this.showModal(html);
  }

  showModal(innerHTML){
    const m=document.getElementById('compare-modal'); const body=document.getElementById('compare-body');
    body.innerHTML=innerHTML; m.style.display='block'; m.setAttribute('aria-hidden','false');
  }
  hideModal(){
    const m=document.getElementById('compare-modal'); m.style.display='none'; m.setAttribute('aria-hidden','true');
  }

  cardHTML(article,idx){
    const title=this.truncate(article?.title,120)||'Untitled';
    const desc=this.truncate(article?.description,180)||'No description available.';
    const srcName=article?.source?.name||'Unknown';
    const dateText=this.humanTime(article?.publishedAt);
    const img=article?.image||''; const url=article?.url||'#';

    const detected=(article.bias||'').trim();
    const biasLabelMap={'left':'Left','lean-left':'Center Left','center':'Center','lean-right':'Center Right','right':'Right'};
    const biasLabel=biasLabelMap[detected]||'Unknown';
    const biasClass=detected||'unknown';

    // reliability tier shown in green badge
    const tierLabel = (article.tier==='legacy') ? 'Legacy' :
                      (article.tier==='less-legacy') ? 'Less legacy' :
                      (article.tier==='unidentified') ? 'Unidentified' : 'Unrated';

    return `
      <article class="article-card" data-url="${this.escape(url)}" tabindex="0" aria-label="${this.escape(title)}">
        <input type="checkbox" class="select-box" data-index="${idx}" aria-label="select for compare"/>
        <div class="article-source">
          <div class="source-logo" aria-hidden="true">${this.initial(srcName)}</div>
          <div class="source-info">
            <div class="source-name">${this.escape(srcName)}</div>
            <div class="source-meta">
              <span class="reliability-badge">${this.escape(tierLabel)}</span>
              <span class="bias-badge ${this.escape(biasClass)}">${this.escape(biasLabel)}</span>
            </div>
          </div>
        </div>
        ${img?`<img class="thumb" src="${this.escape(img)}" alt="" onerror="this.style.display='none'">`:''}
        <div class="article-content">
          <h3 class="article-title">${this.escape(title)}</h3>
          <div class="article-meta">
            <span>${this.escape(dateText)}</span>
            <span>${this.escape(new URL(url,location.href).hostname||'')}</span>
          </div>
          <p class="article-description">${this.escape(desc)}</p>
          <div class="article-actions">
            <a class="link-btn" href="${this.escape(url)}" target="_blank" rel="noopener noreferrer">Read full article →</a>
          </div>
        </div>
      </article>
    `;
  }

  truncate(t,n){ if(!t) return ''; return t.length>n? t.slice(0,n-1)+'…' : t; }
  humanTime(iso){ if(!iso) return 'Unknown'; const d=new Date(iso); if(isNaN(d)) return 'Unknown';
    const diff=Date.now()-d.getTime(); const h=Math.floor(diff/(1000*60*60));
    if(h<1) return 'Just now'; if(h<24) return `${h}h ago`; const days=Math.floor(h/24);
    if(days===1) return 'Yesterday'; return d.toLocaleDateString();
  }
  initial(name){ const c=(name||'').trim()[0]; return (c||'?').toUpperCase(); }
  escape(str){ return String(str||'').replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
}
document.addEventListener('DOMContentLoaded',()=>new NewsApp());
</script>
</body>
</html>
